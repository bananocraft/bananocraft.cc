{{ define "main" }}
<div class="post">
  <h1 class="post-title">{{ .Title | markdownify }}</h1>

  <div class="post-content">
    <div id="feed-container">
      <div id="feed-search-wrap">
        <input type="text" id="feed-search" placeholder="Filter by player..." autocomplete="off" spellcheck="false" />
      </div>
      <p id="feed-loading" style="color: var(--accent); font-family: monospace;">Loading feed...</p>
      <ul id="feed-list"></ul>
      <div id="feed-scroll-sentinel"></div>
    </div>
  </div>
</div>

<style>
  #feed-search-wrap {
    margin-bottom: 1rem;
  }
  #feed-search {
    width: 100%;
    max-width: 300px;
    padding: 0.4rem 0.6rem;
    font-family: monospace;
    font-size: 0.9rem;
    color: var(--color);
    background: var(--background);
    border: 1px solid var(--accent);
    border-radius: 4px;
    outline: none;
  }
  #feed-search:focus {
    box-shadow: 0 0 0 2px var(--accent);
  }
  #feed-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #feed-list li {
    padding: 0.5rem 0;
    border-bottom: 1px dashed var(--accent);
    font-family: monospace;
    font-size: 0.95rem;
  }
  #feed-list li:last-child {
    border-bottom: none;
  }
  .feed-player {
    color: var(--accent);
    font-weight: bold;
  }
  .feed-amount {
    color: #fbec5d;
    font-weight: bold;
  }
  .feed-timestamp {
    display: block;
    color: #888;
    font-size: 0.75rem;
    margin-top: 0.15rem;
  }
  .feed-ago {
    color: #aaa;
    font-size: 0.8rem;
    margin-left: 0.5rem;
  }
  .feed-pickaxe {
    height: 1.1em;
    vertical-align: middle;
    margin-left: 0.3rem;
  }
  #feed-empty {
    color: #888;
    font-style: italic;
  }
  #feed-scroll-sentinel {
    height: 1px;
  }
</style>

<script>
(function() {
  var FEED_API = "https://feed.bananocraft.cc/api/events";
  var POLL_INTERVAL = 15000;
  var BATCH_SIZE = 50;

  var allEvents = [];
  var hasMore = true;
  var loading = false;
  var filterText = "";
  var initialLoad = true;

  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  function timeAgo(ts) {
    var diff = Math.floor((Date.now() - ts) / 1000);
    if (diff < 60) return "just now";
    if (diff < 3600) return Math.floor(diff / 60) + "m ago";
    if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
    return Math.floor(diff / 86400) + "d ago";
  }

  function formatLocalTime(ts) {
    var d = new Date(ts);
    return d.toLocaleString(undefined, {
      year: "numeric", month: "short", day: "numeric",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    });
  }

  function makeEventHtml(e) {
    return '<span class="feed-player">' + escapeHtml(e.player) + "</span>" +
      " just found " +
      '<span class="feed-amount">' + e.amount + " ban</span>" +
      " while " + escapeHtml(e.action) +
      ' <img src="/bananominer_pickaxe.png" alt="â›" class="feed-pickaxe" />' +
      '<span class="feed-ago">' + timeAgo(e.timestamp) + "</span>" +
      '<span class="feed-timestamp">' + formatLocalTime(e.timestamp) + "</span>";
  }

  function matchesFilter(e) {
    if (!filterText) return true;
    return e.player.toLowerCase().indexOf(filterText) !== -1;
  }

  function renderAll() {
    var list = document.getElementById("feed-list");
    list.innerHTML = "";
    var visible = allEvents.filter(matchesFilter);
    if (visible.length === 0) {
      list.innerHTML = '<li id="feed-empty">No rewards yet... go mine something!</li>';
      return;
    }
    visible.forEach(function(e) {
      var li = document.createElement("li");
      li.innerHTML = makeEventHtml(e);
      list.appendChild(li);
    });
  }

  function appendEvents(events) {
    var list = document.getElementById("feed-list");
    var emptyEl = document.getElementById("feed-empty");
    if (emptyEl) emptyEl.parentNode.removeChild(emptyEl);
    events.forEach(function(e) {
      if (!matchesFilter(e)) return;
      var li = document.createElement("li");
      li.innerHTML = makeEventHtml(e);
      list.appendChild(li);
    });
  }

  function fetchBatch(offset, cb) {
    loading = true;
    fetch(FEED_API + "?limit=" + BATCH_SIZE + "&offset=" + offset)
      .then(function(res) {
        if (!res.ok) throw new Error("Feed unavailable");
        return res.json();
      })
      .then(function(data) {
        loading = false;
        hasMore = data.hasMore;
        cb(data.events || []);
      })
      .catch(function() {
        loading = false;
        if (initialLoad) {
          document.getElementById("feed-loading").textContent =
            "Feed currently unavailable. Check back soon!";
        }
      });
  }

  function loadInitial() {
    fetchBatch(0, function(events) {
      document.getElementById("feed-loading").style.display = "none";
      initialLoad = false;
      allEvents = events;
      renderAll();
    });
  }

  function loadMore() {
    if (loading || !hasMore) return;
    fetchBatch(allEvents.length, function(events) {
      allEvents = allEvents.concat(events);
      appendEvents(events);
    });
  }

  // Poll for new events (prepend to top)
  function pollNew() {
    if (allEvents.length === 0) {
      loadInitial();
      return;
    }
    fetch(FEED_API + "?limit=" + BATCH_SIZE + "&offset=0")
      .then(function(res) { return res.json(); })
      .then(function(data) {
        var newest = data.events || [];
        if (newest.length === 0) return;
        var existingIds = {};
        allEvents.forEach(function(e) { existingIds[e.id] = true; });
        var brandNew = newest.filter(function(e) { return !existingIds[e.id]; });
        if (brandNew.length > 0) {
          allEvents = brandNew.concat(allEvents);
          renderAll();
        }
      })
      .catch(function() {});
  }

  // Infinite scroll via IntersectionObserver
  function setupInfiniteScroll() {
    var sentinel = document.getElementById("feed-scroll-sentinel");
    if (!("IntersectionObserver" in window)) return;
    var observer = new IntersectionObserver(function(entries) {
      if (entries[0].isIntersecting) loadMore();
    }, { rootMargin: "200px" });
    observer.observe(sentinel);
  }

  // Search / filter
  document.getElementById("feed-search").addEventListener("input", function(ev) {
    filterText = (ev.target.value || "").toLowerCase().trim();
    renderAll();
  });

  loadInitial();
  setupInfiniteScroll();
  setInterval(pollNew, POLL_INTERVAL);
})();
</script>
{{ end }}
